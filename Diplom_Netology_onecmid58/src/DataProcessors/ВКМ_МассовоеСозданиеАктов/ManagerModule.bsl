#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область СлужебныеПроцедурыИФункции

// Формирует список договоров и связанных с ними реализаций за указанный месяц. При необходимости создает новые реализации.
//
// Параметры:
//   Дата - Дата - Дата, для которой формируется список
//   СоздатьОбъект - Булево - Признак необходимости создания реализации, если она отсутствует
//
// Возвращаемое значение:
//   Массив из Структура - Массив структур с полями "Договор" и "Реализация"
Функция СозданиеСпискаНаСервере(Дата, СоздатьОбъект) Экспорт

	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДоговорыКонтрагентов.Владелец КАК Контрагент,
	|	ДоговорыКонтрагентов.Ссылка КАК Договор,
	|	ДоговорыКонтрагентов.Организация КАК Организация,
	|	РеализацияТоваровУслуг.Ссылка КАК Реализация
	|ПОМЕСТИТЬ ВТ_Результат
	|ИЗ
	|	Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
	|		ПО ДоговорыКонтрагентов.Ссылка = РеализацияТоваровУслуг.Договор
	|			И РеализацияТоваровУслуг.Дата МЕЖДУ &ДатаНачало И &ДатаОкончание
	|			И РеализацияТоваровУслуг.ПометкаУдаления = ЛОЖЬ
	|ГДЕ
	|	&Дата МЕЖДУ ДоговорыКонтрагентов.ВКМ_ДатаНачала И ДоговорыКонтрагентов.ВКМ_ДатаОкончания
	|	И ДоговорыКонтрагентов.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ВКМ_АбонентскоеОбслуживание)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Результат.Договор КАК Договор,
	|	ВТ_Результат.Реализация КАК Реализация,
	|	ВТ_Результат.Организация КАК Организация,
	|	ВТ_Результат.Контрагент КАК Контрагент
	|ИЗ
	|	ВТ_Результат КАК ВТ_Результат";

	Запрос.УстановитьПараметр("Дата", Дата);
	Запрос.УстановитьПараметр("ДатаНачало", НачалоМесяца(Дата));
	Запрос.УстановитьПараметр("ДатаОкончание", КонецМесяца(Дата));

	РезультатЗапроса = Запрос.Выполнить().Выгрузить();

	МассивРеализаций = Новый Массив;

	Для Каждого СтрокаРезультата Из РезультатЗапроса Цикл
		ТекущаяРеализация = СтрокаРезультата.Реализация;

		Если ЗначениеЗаполнено(ТекущаяРеализация) Тогда
			// Если документ найден - перезаполняем его
			ПерезаполнитьРеализацию(ТекущаяРеализация, СтрокаРезультата);
		Иначеесли СоздатьОбъект Тогда
			// Если документ не найден и установлен флаг "СоздатьОбъект" - создаем новый
			ТекущаяРеализация = СозданиеРеализации(СтрокаРезультата, КонецМесяца(Дата));
		КонецЕсли;

		МассивРеализаций.Добавить(Новый Структура("Договор, Реализация", СтрокаРезультата.Договор, ТекущаяРеализация));

	КонецЦикла;

	Возврат МассивРеализаций;

КонецФункции

// Процедура перезаполняет и проводит существующий документ РеализацияТоваровУслуг
// на основе актуальных данных из договора.
//
// Параметры:
//  СсылкаНаДокумент - ДокументСсылка.РеализацияТоваровУслуг - Ссылка на существующий документ.
//  ДанныеДляЗаполнения - Структура - Данные для заполнения (Контрагент, Организация, Договор).
//
Процедура ПерезаполнитьРеализацию(СсылкаНаДокумент, ДанныеДляЗаполнения)
	
	Попытка
		НачатьТранзакцию();
		
		// Получаем объект документа для изменения
		ОбъектДокумента = СсылкаНаДокумент.ПолучитьОбъект();
		
		// Обновляем реквизиты шапки на случай, если они изменились в договоре
		ОбъектДокумента.Договор = ДанныеДляЗаполнения.Договор;
		ОбъектДокумента.Контрагент = ДанныеДляЗаполнения.Контрагент;
		ОбъектДокумента.Организация = ДанныеДляЗаполнения.Организация;
		
		// Вызываем процедуру автозаполнения, которая пересчитает товары/услуги
		ОбъектДокумента.ВКМ_ВыполнитьАвтозаполнение();
		
		// Обновляем ответственного
		ОбъектДокумента.Ответственный = Пользователи.ТекущийПользователь();
		
		// Проверка на корректность заполнения перед записью
		Если Не ОбъектДокумента.ПроверитьЗаполнение() Тогда
			ОбщегоНазначения.СообщитьПользователю(СтрШаблон(
				"Не удалось перезаполнить документ: %1. Не все обязательные данные заполнены после обновления",
				СсылкаНаДокумент));
			ОтменитьТранзакцию();
			Возврат;
		КонецЕсли;

		ОбъектДокумента.Записать(РежимЗаписиДокумента.Проведение, РежимПроведенияДокумента.Неоперативный);

		ЗафиксироватьТранзакцию();
		
	Исключение
		// В случае любой ошибки откатываем все изменения
		ОтменитьТранзакцию();

		ИнформацияОбОшибке = ИнформацияОбОшибке();
		ТекстОшибки = ОбработкаОшибок.ПодробноеПредставлениеОшибки(ИнформацияОбОшибке);

		ОбщегоНазначения.СообщитьПользователю(СтрШаблон(
			"Не удалось перезаписать и провести документ реализации по Договору: %1. Ошибка: %2", 
			ДанныеДляЗаполнения.Договор, ТекстОшибки));

		ЗаписьЖурналаРегистрации("ВКМ_МассовоеСозданиеАктов.ПерезаполнитьРеализацию", УровеньЖурналаРегистрации.Ошибка, , ,
			"Ошибка при перезаписи документа: " + ТекстОшибки);
	КонецПопытки;
	
КонецПроцедуры

// Функция создает, заполняет и проводит документ РеализацииТоваровУслуг
// на основе данных из структуры "Результат".
//
// Параметры:
//  Результат - Структура - Данные для заполнения документа (Контрагент, Организация, Договор).
//  Дата - Дата - Дата документа.
//
// Возвращаемое значение:
//  ДокументСсылка.РеализацияТоваровУслуг - Ссылка на созданный и проведенный документ.
//  Неопределено - если возникла ошибка или документ не прошел проверку заполнения.
Функция СозданиеРеализации(Результат, Дата)

	НовыйДок = Документы.РеализацияТоваровУслуг.СоздатьДокумент();
	НовыйДок.Дата = Дата;
	НовыйДок.Договор = Результат.Договор;
	НовыйДок.Контрагент = Результат.Контрагент;
	НовыйДок.Организация = Результат.Организация;
	НовыйДок.ВКМ_ВыполнитьАвтозаполнение();
	НовыйДок.Ответственный = Пользователи.ТекущийПользователь();
	
	// Проверка на корректность заполнения перед транзакцией
	Если Не НовыйДок.ПроверитьЗаполнение() Тогда
		ОбщегоНазначения.СообщитьПользователю(СтрШаблон(
			"Не удалось создать документ реализации по Договору: %1. Не все обязательные данные заполнены",
			Результат.Договор));
		Возврат Неопределено;
	КонецЕсли;

	Попытка
		НачатьТранзакцию();

		НовыйДок.Записать(РежимЗаписиДокумента.Проведение, РежимПроведенияДокумента.Неоперативный);

		ЗафиксироватьТранзакцию();

		Возврат НовыйДок.Ссылка;

	Исключение
		// В случае любой ошибки откатываем все изменения
		ОтменитьТранзакцию();

		ИнформацияОбОшибке = ИнформацияОбОшибке();
		ТекстОшибки = ОбработкаОшибок.ПодробноеПредставлениеОшибки(ИнформацияОбОшибке);

		ОбщегоНазначения.СообщитьПользователю(СтрШаблон(
			"Не удалось провести документ реализации по Договору: %1. Ошибка: %2", Результат.Договор, ТекстОшибки));

		ЗаписьЖурналаРегистрации("ВКМ_МассовоеСозданиеАктов.СозданиеРеализации", УровеньЖурналаРегистрации.Ошибка, , ,
			"Ошибка при создании и проведении документа: " + ТекстОшибки);

		Возврат Неопределено;
	КонецПопытки;

КонецФункции

#КонецОбласти


#КонецЕсли